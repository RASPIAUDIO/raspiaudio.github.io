<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RASPIAUDIO Open Source App Store</title>
  <meta name="description" content="Easily allow users to install firmware on the web." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <style>
    /* CSS Styles */
    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",
        Roboto, Ubuntu, sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.6;
      background-color: #f5f5f5;
      color: #333;
    }
    header {
      background-color: #89B4BA; /* Updated color */
      padding: 10px 0; /* Reduced padding for smaller header */
      text-align: center;
    }
    .logo img {
      max-width: 20px; /* Further reduced to make the logo smaller */
      height: auto;
    }
    .content {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    h1 {
      text-align: center; /* Centered the title */
      margin-bottom: 30px;
    }
    .container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .left-panel,
    .right-panel {
      width: 48%;
    }
    .selection-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .selection-card {
      flex: 1 1 calc(50% - 15px);
      max-width: calc(50% - 15px);
      border: 1px solid #ccc; /* Thinner border */
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center; /* Align items vertically center */
      background-color: #fafafa;
    }
    /* Specific styles for device cards */
    .device-card {
      justify-content: flex-start; /* Align items to the start */
    }
    .device-card img {
      width: 40px; /* Adjust image size as needed */
      height: 40px;
      object-fit: contain;
      margin-right: 10px; /* Space between image and text */
    }
    .application-card {
      justify-content: center; /* Center align for application cards */
      flex-direction: column;
    }
    .selection-card.selected {
      border-color: #89B4BA; /* Updated color */
      box-shadow: 0 0 10px rgba(137, 180, 186, 0.5); /* Updated color */
    }
    #device-description,
    #application-description {
      margin-top: 20px;
    }
    .button-row {
      margin-top: 20px;
      text-align: center;
    }
    footer {
      background-color: #89B4BA; /* Updated color */
      padding: 5px 0; /* Further reduced padding */
      text-align: center;
      font-size: 0.8em; /* Smaller font size */
      color: #fff;
    }
    footer a {
      color: #fff;
      text-decoration: underline;
    }
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .left-panel,
      .right-panel {
        width: 100%;
      }
      .selection-card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #333;
        color: #fff;
      }
      header {
        background-color: #444;
      }
      footer {
        background-color: #444;
      }
      a {
        color: #58a6ff;
      }
      .content {
        background-color: #555;
      }
      .selection-card {
        background-color: #666;
        border-color: #888;
      }
      .selection-card.selected {
        border-color: #58a6ff;
        box-shadow: 0 0 10px rgba(88, 166, 255, 0.5);
      }
      .application-card {
        background-color: #666;
      }
    }
  </style>
  <!-- Ajout de la bibliothèque Showdown.js pour convertir Markdown en HTML -->
  <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
</head>
<body>
  <header>
    <a href="https://raspiaudio.com/">
      <img src="./images/Logo_raspiaudio_V3-768x170.png" alt="RASPIAUDIO Logo" class="logo">
    </a>
  </header>

  <style>
    header .logo {
      max-width: 100px; /* Adjust this value to make the logo smaller */
      height: auto;
    }
  </style>
  
  <div class="content">
    <h1>RASPIAUDIO Open Source App Store</h1>
    <div class="container">
      <div class="left-panel">
        <h2>Select a Device:</h2>
        <div id="device-list" class="selection-grid"></div>
        <div id="device-description"></div>
      </div>
      <div class="right-panel">
        <h2>Select an Application:</h2>
        <div id="application-list" class="selection-grid"></div>
        <div id="application-description"></div>
      </div>
    </div>
    <div id="selection" style="text-align: center; margin-top: 20px;">
      Selected Device: <span id="selected-device">None</span><br />
      Selected Application: <span id="selected-application">None</span>
    </div>
    <p class="button-row" align="center">
      <esp-web-install-button class="upload-button"></esp-web-install-button>
    </p>
    <!-- ESP Web Tools Script -->
    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@9.4.0/dist/web/install-button.js?module"
    ></script>
    <script>
      // JavaScript pour gérer la logique
      document.addEventListener("DOMContentLoaded", () => {
        const devices = {
          Luxe: {
            html: "./Luxe/Luxe.html",
            image: "./Luxe/Luxe.png",
            applications: {
              Bluetooth: {
                html: "./Luxe/Bluetooth/Bluetooth.html",
                github: "https://github.com/RASPIAUDIO/esp32-bluetooth-speaker",
              },
              Radio: {
                html: "./Luxe/Radio/Radio.html",
                github: "https://github.com/RASPIAUDIO/esp32-radio",
              },
              Squeezelite: {
                html: "./Luxe/Squeezelite/Squeezelite.html",
                github: "https://github.com/RASPIAUDIO/ESP32-Squeezelite",
              },
              Homeassistant: {
                html: "./Luxe/Homeassistant/Homeassistant.html",
                github: "https://github.com/RASPIAUDIO/esp-home",
              },
            },
          },
          Mncast: {
            html: "./Mncast/Mncast.html",
            image: "./Mncast/Mncast.png",
            applications: {
              Bluetooth: {
                html: "./Mncast/Bluetooth/Bluetooth.html",
                github: "https://github.com/RASPIAUDIO/esp32-bluetooth-speaker",
              },
              Radio: {
                html: "./Mncast/Radio/Radio.html",
                github: "https://github.com/RASPIAUDIO/esp32-radio",
              },
              Squeezelite: {
                html: "./Mncast/Squeezelite/Squeezelite.html",
                github: "https://github.com/RASPIAUDIO/ESP32-Squeezelite",
              },
              Homeassistant: {
                html: "./Mncast/Homeassistant/Homeassistant.html",
                github: "https://github.com/RASPIAUDIO/esp-home",
              },
            },
          },
          Proto: {
            html: "./Proto/Proto.html",
            image: "./Proto/Proto.png",
            applications: {
              Bluetooth: {
                html: "./Proto/Bluetooth/Bluetooth.html",
                github: "https://github.com/RASPIAUDIO/esp32-bluetooth-speaker",
              },
              Radio: {
                html: "./Proto/Radio/Radio.html",
                github: "https://github.com/RASPIAUDIO/esp32-radio",
              },
              Squeezelite: {
                html: "./Proto/Squeezelite/Squeezelite.html",
                github: "https://github.com/RASPIAUDIO/ESP32-Squeezelite",
              },
              Homeassistant: {
                html: "./Proto/Homeassistant/Homeassistant.html",
                github: "https://github.com/RASPIAUDIO/esp-home",
              },
              TWSleft: {
                html: "./Proto/TWSleft/TWSleft.html",
                github: "https://github.com/RASPIAUDIO/esp32-bluetooth-speaker",
              },
              TWSright: {
                html: "./Proto/TWSright/TWSright.html",
                github: "https://github.com/RASPIAUDIO/esp32-bluetooth-speaker",
              },
            },
          },
          Moduloxbrain: {
            html: "./Moduloxbrain/Moduloxbrain.html",
            image: "./Moduloxbrain/Moduloxbrain.png",
            applications: {
              Sampler: {
                html: "./Moduloxbrain/Sampler/Sampler.html",
                github: "https://github.com/RASPIAUDIO/Modulox_Sampler",
              },
              VA: {
                html: "./Moduloxbrain/VA/VA.html",
                github: "https://github.com/RASPIAUDIO/Modulox_VA",
              },
              FM: {
                html: "./Moduloxbrain/FM/FM.html",
                github: "https://github.com/RASPIAUDIO/Modulox_FM",
              },
              Granular: {
                html: "./Moduloxbrain/Granular/Granular.html",
                github: "https://github.com/RASPIAUDIO/Modulox_Granular",
              },
              Organ: {
                html: "./Moduloxbrain/Organ/Organ.html",
                github: "https://github.com/RASPIAUDIO/Modulox_Organ",
              },
              Modunoid: {
                html: "./Moduloxbrain/Modunoid/Modunoid.html",
                github: "https://github.com/RASPIAUDIO/Modulox_Modunoid",
              },
            },
          },
          MuseRadio: {
            html: "./MuseRadio/MuseRadio.html",
            image: "./MuseRadio/MuseRadio.png",
            applications: {
              Radio: {
                html: "./MuseRadio/Radio/Radio.html",
                github: "https://github.com/RASPIAUDIO/MuseRadio-DEMO",
              },
              Squeezelite: {
                html: "./MuseRadio/Squeezelite/Squeezelite.html",
                github: "https://github.com/RASPIAUDIO/ESP32-Squeezelite",
              },
              Homeassistant: {
                html: "./MuseRadio/Homeassistant/Homeassistant.html",
                github: "https://github.com/RASPIAUDIO/esphomeRadio",
              },
            },
          },
        };

        const deviceList = document.getElementById("device-list");
        const applicationList = document.getElementById("application-list");
        const selectedDeviceElement = document.getElementById("selected-device");
        const selectedApplicationElement = document.getElementById("selected-application");
        const deviceDescription = document.getElementById("device-description");
        const applicationDescription = document.getElementById("application-description");
        const installButton = document.querySelector("esp-web-install-button");

        let selectedDevice = null;
        let selectedApplication = null;

        // Fonction pour générer la liste des appareils
        for (let deviceName in devices) {
          let deviceCard = document.createElement("div");
          deviceCard.className = "selection-card device-card";
          deviceCard.dataset.device = deviceName;

          let deviceImage = document.createElement("img");
          deviceImage.src = devices[deviceName].image;
          deviceImage.alt = `${deviceName} Image`;

          let deviceLabel = document.createElement("span");
          deviceLabel.textContent = deviceName;

          deviceCard.appendChild(deviceImage);
          deviceCard.appendChild(deviceLabel);
          deviceList.appendChild(deviceCard);

          // Écouteur d'événement pour la sélection de l'appareil
          deviceCard.addEventListener("click", () => {
            // Désélectionner tous les appareils
            deviceList.querySelectorAll('.device-card').forEach(card => {
              card.classList.remove('selected');
            });
            deviceCard.classList.add('selected');

            selectedDevice = deviceName;
            selectedDeviceElement.textContent = selectedDevice;
            selectedApplication = null;
            selectedApplicationElement.textContent = "None";
            applicationDescription.innerHTML = "";
            loadDeviceHTML(selectedDevice);
            generateApplicationList(selectedDevice);
            updateInstallButton();
          });
        }

        // Fonction pour charger le HTML spécifique à l'appareil
        function loadDeviceHTML(deviceName) {
          let device = devices[deviceName];
          fetch(device.html)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`Erreur HTTP ! statut : ${response.status}`);
              }
              return response.text();
            })
            .then((data) => {
              deviceDescription.innerHTML = data;
            })
            .catch((error) => {
              console.error(error);
              deviceDescription.innerHTML = "Description de l'appareil non disponible.";
            });
        }

        // Fonction pour générer la liste des applications
        function generateApplicationList(deviceName) {
          applicationList.innerHTML = "";
          let applications = devices[deviceName].applications;
          Object.keys(applications).forEach((appName) => {
            let appCard = document.createElement("div");
            appCard.className = "selection-card application-card";
            appCard.dataset.application = appName;

            let appLabel = document.createElement("span");
            appLabel.textContent = appName;

            appCard.appendChild(appLabel);
            applicationList.appendChild(appCard);

            // Écouteur d'événement pour la sélection de l'application
            appCard.addEventListener("click", () => {
              // Désélectionner toutes les applications
              applicationList.querySelectorAll('.application-card').forEach(card => {
                card.classList.remove('selected');
              });
              appCard.classList.add('selected');

              selectedApplication = appName;
              selectedApplicationElement.textContent = selectedApplication;
              loadApplicationHTML(selectedDevice, selectedApplication);
              updateInstallButton();
            });
          });

          // Sélection automatique de la première application
          if (Object.keys(applications).length > 0) {
            const firstAppCard = applicationList.querySelector('.application-card');
            if (firstAppCard) {
              firstAppCard.click();
            }
          }
        }

        // Fonction pour charger le HTML de l'application ou le README.md
        function loadApplicationHTML(deviceName, appName) {
          let application = devices[deviceName].applications[appName];
          let path = application.html;
          fetch(path)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`Erreur HTTP ! statut : ${response.status}`);
              }
              return response.text();
            })
            .then((data) => {
              applicationDescription.innerHTML = data;
            })
            .catch((error) => {
              console.error(error);
              // Si le fichier HTML n'est pas disponible, charger le README.md depuis GitHub
              fetchReadmeFromGithub(application.github);
            });
        }

        // Fonction pour obtenir l'URL brute du README.md sur GitHub
        function getRawReadmeUrl(githubUrl, branch) {
          let parts = githubUrl.replace("https://github.com/", "").split("/");
          let user = parts[0];
          let repo = parts[1];
          let readmeUrl = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/README.md`;
          return readmeUrl;
        }

        // Fonction pour charger le README.md depuis GitHub
        function fetchReadmeFromGithub(githubUrl) {
          let branches = ["main", "master"];
          let fetchReadme = (branchIndex) => {
            if (branchIndex >= branches.length) {
              applicationDescription.innerHTML = "Description de l'application non disponible.";
              return;
            }
            let branch = branches[branchIndex];
            let readmeUrl = getRawReadmeUrl(githubUrl, branch);
            fetch(readmeUrl)
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`Erreur HTTP ! statut : ${response.status}`);
                }
                return response.text();
              })
              .then((markdown) => {
                // Convertir le Markdown en HTML
                let converter = new showdown.Converter();
                let html = converter.makeHtml(markdown);
                applicationDescription.innerHTML = html;
              })
              .catch((error) => {
                console.error(error);
                // Essayer la prochaine branche
                fetchReadme(branchIndex + 1);
              });
          };
          fetchReadme(0);
        }

        // Fonction pour mettre à jour le bouton d'installation
        function updateInstallButton() {
          if (selectedDevice && selectedApplication) {
            let manifestPath = `./${selectedDevice}/${selectedApplication}/manifest_${selectedDevice}_${selectedApplication}.json`;
            installButton.manifest = manifestPath;
            installButton.style.visibility = "visible";
          } else {
            installButton.style.visibility = "hidden";
          }
        }

        // Initialisation
        function initialize() {
          const defaultDevice = 'Luxe'; // Définit votre appareil par défaut ici
          const deviceCards = deviceList.querySelectorAll('.device-card');
          deviceCards.forEach(card => {
            if (card.dataset.device === defaultDevice) {
              card.click();
            }
          });
        }

        // Masquer le bouton d'installation initialement
        installButton.style.visibility = "hidden";

        // Initialiser les sélections au chargement de la page
        initialize();
      });
    </script>
  </div>
  <footer>
    <p>
      Installer powered by
      <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>
    </p>
    <p>
      The Bluetooth and Radio applications were created by Raspiaudio.<br />
      Squeezelite and ESP Home are not created by Raspiaudio.<br />
      Source code of this site is available
      <a href="https://github.com/RASPIAUDIO/raspiaudio.github.io" target="_blank">here</a>.
    </p>
  </footer>
</body>
</html>
